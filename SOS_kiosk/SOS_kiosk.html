<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="Morgan Rehnberg">

    <title>SOS Kiosk</title>

  </head>

  <body>


  <script>

    function askForDefaults() {

      // Send a message to the local helper and ask for the latest configuration
      // defaults, then use them.

      requestString = `action=getDefaults`;

      var xhr = new XMLHttpRequest();
      xhr.open("POST", helperIP, true);
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.onreadystatechange = function () {

        if (this.readyState != 4) return;

        if (this.status == 200) {
          readUpdate(this.responseText);
        }
    };
      xhr.send(requestString);
    }

    function readUpdate(responseText) {

      // Function to read a message from the server and take action based
      // on the contents

      var update = JSON.parse(responseText);

      if ("id" in update) {
        id = update["id"];
      }
      if ("type" in update) {
        type = update["type"]
      }
      if (("server_ip_address" in update) && ("server_port" in update)) {
        serverAddress = "http://" + update["server_ip_address"] + ":" + update["server_port"];
      }
    }

    function sendPing() {

      // Contact the control server and ask for any updates

      if (serverAddress != "") {
        requestString = `class=exhibitComponent&id=${id}&type=${type}`;

        var xhr = new XMLHttpRequest();
        xhr.open("POST", serverAddress, true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onerror = function() {
        }
        xhr.onreadystatechange = function () {

          if (this.readyState != 4) return;

          if (this.status == 200) {
            readUpdate(this.responseText);
          }
      };
        xhr.send(requestString);
      }
    }

    function rebuildInterface() {

      // Repopulate the clip buttons in response to a change in playlist

      // Retreive the new clip list
      requestString = `action=SOS_getClipList`;

      var xhr = new XMLHttpRequest();
      xhr.open("POST", helperIP, true);
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.onerror = function() {
      }
      xhr.overrideMimeType( "text/plain; charset=x-user-defined" );
      xhr.onreadystatechange = function () {

        if (this.readyState != 4) return;

        if (this.status == 200) {
          var clipList = JSON.parse(this.responseText);
          console.log(clipList)
        }
    };
      xhr.send(requestString);
    }

    function getSOSState() {

      requestString = `action=SOS_getState`;

      var xhr = new XMLHttpRequest();
      xhr.open("POST", helperIP, true);
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.onerror = function() {
      }
      xhr.overrideMimeType( "text/plain; charset=x-user-defined" );
      xhr.onreadystatechange = function () {

        if (this.readyState != 4) return;

        if (this.status == 200) {
          var state_dict = JSON.parse(this.responseText);
          var keys = Object.keys(state_dict);

          for (var i=0;i<keys.length;i++) {
            key = keys[i];
            if (key in config) {
              if (key == 'playlist_name') {
                if (config[key] != state_dict[key]) {
                  console.log("New playlist detected")
                  rebuildInterface();
                }
              } else if (key == 'clip_number') {
                if (config[key] != state_dict[key]) {
                  console.log("Clip has changed")
                }
              }
            } else {
              config[key] = state_dict[key]
            }
          }
        }
    };
      xhr.send(requestString);
    }

    // These will be replaced by the values specified in defaults.ini
    var id = 'SOS-KIOSK';
    var type = 'KIOSK';
    var serverAddress = ""; // The address of the main control server
    var helperIP = "http://localhost:8000"; // This is the address of the local helper process that can interact with the OS
    var source = "";

    config = {'playlist_name': null,
              'clip_number': null};

    // sendPing();
    // setInterval(sendPing, 5000);

  </script>

  </body>

</html>
