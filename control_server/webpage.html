<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="A system for controling exhibit components">
    <meta name="author" content="Morgan Rehnberg">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <title>Control server</title>

    <style>
      .handCursor {
        cursor: pointer;
      }
    </style>
  </head>

  <body>

    <main role="main" class="container">

      <div class="row mt-2 mb-2">
        <div class="col">
          <H1><div id="exhibitNameField"></div></H1>
        </div>
      </div>

      <nav>
        <div class="nav nav-tabs" id="nav-tab" role="tablist">
          <a class="nav-item nav-link active" id="nav-components-tab" data-toggle="tab" href="#nav-components" role="tab" aria-controls="nav-components" aria-selected="true">Components</a>
          <a class="nav-item nav-link" id="nav-schedule-tab" data-toggle="tab" href="#nav-schedule" role="tab" aria-controls="nav-schedule" aria-selected="false">Schedule</a>
          <a class="nav-item nav-link" id="nav-settings-tab" data-toggle="tab" href="#nav-settings" role="tab" aria-controls="nav-settings" aria-selected="false">Settings</a>
        </div>
      </nav>
      <div class="tab-content" id="nav-tabContent">
        <div class="tab-pane fade show active" id="nav-components" role="tabpanel" aria-labelledby="nav-components-tab">
          <div class="row" id="componentGroupsRow">
          </div>
        </div>
        <div class="tab-pane fade" id="nav-schedule" role="tabpanel" aria-labelledby="nav-schedule-tab">

          <div class="modal" tabindex="-1" role="dialog" id="scheduleEditModal">
            <div class="modal-dialog modal-dialog-centered" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Edit schedule</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <form id="scheduleEditForm">
                    <div class="form-group">
                      <label for="daySelect">Select day(s)</label>
                      <select multiple class="form-control" id="daySelect">
                        <option>Monday</option>
                        <option>Tuesday</option>
                        <option>Wednesday</option>
                        <option>Thursday</option>
                        <option>Friday</option>
                        <option>Saturday</option>
                        <option>Sunday</option>
                      </select>

                    </div>
                    <div class="form-group">
                      <div class="row">
                        <div class="col-6">
                          <label for="onTimeEntry">Turn on time</label>
                          <input type="text" class="form-control" id="onTimeEntry" placeholder="e.g., 9:30 AM">
                        </div>
                        <div class="col-6">
                          <label for="offTimeEntry">Turn off time</label>
                          <input type="text" class="form-control" id="offTimeEntry" placeholder="e.g., 5:30 PM">
                        </div>
                        <div class='col mt-2'>
                          <p>To remove a scheduled action, leave the field blank.</p>
                        </div>
                      </div>
                    </div>
                  </form>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-primary" onclick="sendScheduleUpdate()" id="scheduleEditSubmitButton">Save changes</button>
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                </div>
              </div>
            </div>
          </div>

          <div class="row mt-4">
            <div class='col'>
              <h4><b>Next scheduled action: </b><span id="Schedule_next_event"></span></h4>
            </div>
          </div>
          <div class='row mt-2'>
            <div class="col-sm-10 col-md-7 col-lg-5 col-xl-5">
              <table class="table table-striped">
                <thead class="thead-dark">
                  <tr>
                    <th scope="col">Day</th>
                    <th scope="col">Turn on time</th>
                    <th scope="col">Turn off time</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <th scope="row">Monday</th>
                    <td><div id="Schedule_monday_on"></div></td>
                    <td><div id="Schedule_monday_off"></div></td>
                  </tr>
                  <tr>
                    <th scope="row">Tuesday</th>
                    <td><div id="Schedule_tuesday_on"></div></td>
                    <td><div id="Schedule_tuesday_off"></div></td>
                  </tr>
                  <tr>
                    <th scope="row">Wednesday</th>
                    <td><div id="Schedule_wednesday_on"></div></td>
                    <td><div id="Schedule_wednesday_off"></div></td>
                  </tr>
                  <tr>
                    <th scope="row">Thursday</th>
                    <td><div id="Schedule_thursday_on"></div></td>
                    <td><div id="Schedule_thursday_off"></div></td>
                  </tr>
                  <tr>
                    <th scope="row">Friday</th>
                    <td><div id="Schedule_friday_on"></div></td>
                    <td><div id="Schedule_friday_off"></div></td>
                  </tr>
                  <tr>
                    <th scope="row">Saturday</th>
                    <td><div id="Schedule_saturday_on"></div></td>
                    <td><div id="Schedule_saturday_off"></div></td>
                  </tr>
                  <tr>
                    <th scope="row">Sunday</th>
                    <td><div id="Schedule_sunday_on"></div></td>
                    <td><div id="Schedule_sunday_off"></div></td>
                  </tr>
                </tbody>
              </table>
              <button class='btn btn-info' data-toggle="modal" data-target="#scheduleEditModal">Edit schedule  </button>
            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="nav-settings" role="tabpanel" aria-labelledby="nav-settings-tab">

          <div class="modal" tabindex="-1" role="dialog" id="changeExhibitModal">
            <div class="modal-dialog modal-dialog-centered" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Are you sure?</h5>
                </div>
                <div class="modal-body">
                  Changing the exhibit will be immediately visible to guests and the changing process may be unsightly for up to a minute.
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-danger" onclick="changeExhibit(true)" id="exhibitChangeConfirmationButton">Change exhibit</button>
                  <button type="button" class="btn btn-success" data-dismiss="modal">Cancel</button>
                </div>
              </div>
            </div>
          </div>

          <div class="row mt-4">
            <div class="col-6 col-md-3 col lg-2">
              <button type="button" class="btn btn-primary" id="reloadConfigurationButton" onclick="reloadConfiguration()">Reload Config</button>
            </div>
            <div class="col-6 col-md-4 col-lg-3">
              <div class="form-group">
                <label for="exhibitSelect">Set current exhibit</label>
                <select class="form-control" id="exhibitSelect" onchange="changeExhibit(false)"></select>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>

      class ExhibitComponent {

        constructor(id, type) {
          this.id = id;
          this.type = type;
          this.status = "OFFLINE";
          this.buildHTML();
        }

        setStatus(status) {
          this.status = status;

          $("#" + this.id + "StatusField").html(status);

          var btnClass = this.getButtonColorClass();
          // Strip all existing classes
          $("#" + this.id + "MainButton").removeClass("btn-primary btn-warning btn-danger btn-success").addClass(btnClass);
            $("#" + this.id + "DropdownButton").removeClass("btn-primary btn-warning btn-danger btn-success").addClass(btnClass);
        }

        getButtonColorClass() {

          // Get the Bootstrap class based on the current status
          var btnClass = 'btn-danger';
          if (this.status == 'ACTIVE') {
            btnClass = 'btn-primary';
          } else if (this.status == "ONLINE") {
            btnClass = 'btn-success';
          } else if (this.status == "WAITING") {
            btnClass = 'btn-warning';
          }
          return btnClass;
        }

        buildHTML() {

          // Function to build the HTML representation of this component
          // and add it to the row of the parent group

          var html = `
            <div class='col-md-12 col-lg-6 mt-1'>
              <div class="btn-group btn-block">
                <button type="button" class="btn btn-danger btn-block" id="${this.id}MainButton"><H5>${this.id}</H5><div id="${this.id}StatusField">OFFLINE</div></button>
                <button type="button" id="${this.id}DropdownButton" class="btn btn-danger dropdown-toggle dropdown-toggle-split"  data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <span class="sr-only">Toggle Dropdown</span>
                </button>
                <div class="dropdown-menu">
                  <a class="dropdown-item handCursor" onclick="queueCommand('${this.id}', 'wakeDisplay')">Wake display</a>
                  <a class="dropdown-item handCursor" onclick="queueCommand('${this.id}', 'sleepDisplay')">Sleep display</a>
                </div>
              </div>
            </div>
          `;

          $('#'+this.type+'ComponentList').append(html);
        }
      }

      class ExhibitComponentGroup {

        constructor(type) {
          this.type = type;
          this.components = [];
          this.buildHTML();
        }

        addComponent(component) {
          this.components.push(component);
          this.sortComponentList();
        }

        sortComponentList() {

          // Sort the component list by ID and then rebuild the HTML
          // representation in order

          // This line does the sorting
          this.components.sort((a,b) => (a.id > b.id) ? 1 : ((b.id > a.id) ? -1 : 0))

          document.getElementById(this.type + "ComponentList").innerHTML = ""
          for (var i=0; i<this.components.length; i++) {
            this.components[i].buildHTML();
          }

        }

        buildHTML() {

          // Function to build the HTML representation of this group
          // and add it to the componentGroupsRow

          var html = `
            <div class='col-md-6 col-lg-5 col-xl-4 mt-4'>
              <div class="btn-group btn-block">
                <button type="button" class="btn btn-secondary btn-block btn-lg">${this.type}</button>
                <button type="button" class="btn btn-secondary dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <span class="sr-only">Toggle Dropdown</span>
                </button>
                <div class="dropdown-menu">
                  <a class="dropdown-item handCursor" onclick="sendGroupCommand('${this.type}', 'wakeDisplay')">Wake all displays</a>
                  <a class="dropdown-item handCursor" onclick="sendGroupCommand('${this.type}', 'sleepDisplay')">Sleep all displays</a>
                </div>
              </div>
              <div class="row" id='${this.type}ComponentList'>
              </div>
            </div>
          `;

          $('#componentGroupsRow').append(html);
        }
      }

      function getExhibitComponent(id) {

        // Function to search the exhibitComponents list for a given id

        var result = exhibitComponents.find(obj => {
          return obj.id === id
        });

        return result;
      }

      function getExhibitComponentGroup(type) {

        // Function to search the exhibitComponents list for a given id

        var result = componentGroups.find(obj => {
          return obj.type === type
        });

        return result;
      }

      function updateComponentFromServer(component) {

        obj = getExhibitComponent(component["id"])
        if (obj != null) {
          // Update the object with the latest info from the server
          obj.setStatus(component["status"]);
        } else {

          // First, make sure the group matching this type exists
          var group = getExhibitComponentGroup(component["type"]);
          if (group == null) {
            var group = new ExhibitComponentGroup(component["type"]);
            componentGroups.push(group);
          }

          // Then create a new component
          var newComponent = new ExhibitComponent(component["id"], component["type"]);
          newComponent.setStatus(component["status"]);
          exhibitComponents.push(newComponent);

          // Add the component to the right group
          group.addComponent(newComponent);
        }
      }

      function setCurrentExhibitName(name) {
        currentExhibit = name;
        document.getElementById("exhibitNameField").innerHTML = name;
        document.title = name;
        updateAvailableExhibits([name]);
      }

      function updateAvailableExhibits(exhibitList) {

        for (var i=0; i<exhibitList.length; i++) {
          // Check if exhibit already exists as an option. If not, add it
          if ($(`#exhibitSelect option[value='${exhibitList[i]}']`).length == 0) {
            $("#exhibitSelect").append(new Option(exhibitList[i], exhibitList[i]));
          }
        }

      }

      function changeExhibit(warningShown) {

        // Send a command to the control server to change the current exhibit

        if (warningShown == false) {
          $("#changeExhibitModal").modal("show");
        }
        else {
          $("#changeExhibitModal").modal("hide");
          var name = $("#exhibitSelect").val();

          requestString = `class=webpage&action=setExhibit&name=${name}`;
          var xhr = new XMLHttpRequest();
          xhr.open("POST", serverIP, true);
          xhr.setRequestHeader('Content-Type', 'application/json');
          xhr.send(requestString);

          askForUpdate();
        }

      }

      function reloadConfiguration() {

        // This function will send a message to the server asking it to reload
        // the current exhibit configuration file and update all the components

        requestString = "class=webpage&action=reloadConfiguration";

        var xhr = new XMLHttpRequest();
        xhr.open("POST", serverIP, true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onreadystatechange = function () {
          if (this.readyState != 4) return;

          if (this.status == 200) {
            var response = JSON.parse(this.responseText);

            if ("result" in response) {
              if (response["result"] == "success") {
                $("#reloadConfigurationButton").html("Success!");
                setTimeout(function() { $("#reloadConfigurationButton").html("Reload Config"); }, 2000);
              }
            }
          }
      };
        xhr.send(requestString);
      }

      function queueCommand(id, cmd) {

        // Function to send a command to the control server that will then
        // be sent to the component the next time it pings the server

        var requestString = `class=webpage&action=queueCommand&id=${id}&command=${cmd}`;

        var xhr = new XMLHttpRequest();
        xhr.open("POST", serverIP, true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onreadystatechange = function () {
          if (this.readyState != 4) return;

          if (this.status == 200) {
          }
      };
        xhr.send(requestString);
      }

      function sendGroupCommand(group, cmd) {

        // Iterate through the components in the given group and queue the command
        // for each

        var group = getExhibitComponentGroup(group);

        for (var i=0; i<group.components.length; i++) {
          queueCommand(group.components[i].id, cmd);
        }
      }

      function populateSchedule(schedule) {

        var keys = ['monday_on', 'monday_off', 'tuesday_on', 'tuesday_off', 'wednesday_on', 'wednesday_off', 'thursday_on', 'thursday_off', 'friday_on', 'friday_off', 'saturday_on', 'saturday_off', 'sunday_on', 'sunday_off', ];
        for (var i=0; i<keys.length; i++) {
          var key = keys[i];
          var item;
          if (key in schedule) {
            item = schedule[key];
          } else item = ""
          document.getElementById("Schedule_"+key).innerHTML = item;
        }

          var action = "";
          if (schedule["Next action"] == "sleepDisplay") {
            action = "Turn exhibit off";
          } else if (schedule["Next action"] == "wakeDisplay") {
            action = "Turn exhibit on";
          }
          var value = ""
          if (schedule["Next time"] != "None") {
            value = `${action}—${schedule["Next time"]}`;
          } else {
            value = `No actions scheduled`;
          }

          document.getElementById("Schedule_next_event").innerHTML = value;
      }

      function sendScheduleUpdate() {
        var days = $('#daySelect').val();
        var onTime = $('#onTimeEntry').val();
        var offTime = $('#offTimeEntry').val();

        if (days.length > 0) {

          var requestString;
          for (var i=0; i<days.length; i++) {
              day = days[i];
              requestString = `class=webpage&action=updateSchedule&day=${day}&onTime=${onTime}&offTime=${offTime}`;

              var xhr = new XMLHttpRequest();
              xhr.open("POST", serverIP, true);
              xhr.setRequestHeader('Content-Type', 'application/json');
              xhr.send(requestString);
          }
          document.getElementById("scheduleEditForm").reset();
          $('#scheduleEditModal').modal('hide')
          askForUpdate();
        } else {
          // We are missing the day field, so pop up a warning to help
          $("#scheduleEditSubmitButton").popover({
                placement: 'right',
                trigger: 'focus',
                content: "You must select at least one day to modify!"
                });
          $("#scheduleEditSubmitButton").popover('show');
        }
      }

      function askForUpdate() {

        requestString = "class=webpage&action=fetchUpdate";

        var xhr = new XMLHttpRequest();
        xhr.open("POST", serverIP, true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onreadystatechange = function () {
          if (this.readyState != 4) return;

          if (this.status == 200) {
              var update = JSON.parse(this.responseText);

              for (var i=0; i<update["length"]; i++) {
                var component = update[String(i)];
                if ("class" in component) {
                  if (component["class"] == "exhibitComponent") {
                    updateComponentFromServer(component);
                  } else if (component["class"] == "gallery") {
                    setCurrentExhibitName(component["currentExhibit"]);
                    updateAvailableExhibits(component["availableExhibits"]);
                  } else if (component["class"] == "schedule") {
                    populateSchedule(component);
                  }
                }
              }
          }
      };
        xhr.send(requestString);
      }

      var serverIP = INSERT_SERVERIP_HERE // This will be automatically inserted by the server before being sent to the client
      var currentExhibit = "";
      var exhibitComponents = [];
      var componentGroups = [];

      askForUpdate();
      setInterval(askForUpdate, 5000);

    </script>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

  </body>
</html>
