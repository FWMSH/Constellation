<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="A system for controling exhibit components">
    <meta name="author" content="Morgan Rehnberg">

    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="icon/green.ico">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">

    <title></title>

    <style>
      pre {
        background-color: #e8eded;
        padding-top: 10px;
        padding-bottom: 10px;
        margin-left: 10px;
        padding-left: 10px;
        padding-right: 10px;
        margin-right: 10px;
      }
      .handCursor {
        cursor: pointer;
      }
      #componentAvailableContentList-thisExhibit {
        max-height: 25vh;
        min-height: 15vh;
        overflow-y: scroll;
      }
      #componentAvailableContentList-allExhibits {
        max-height: 25vh;
        min-height: 15vh;
        overflow-y: scroll;
      }
    </style>
  </head>

  <body>

    <main role="main" class="container">

      <div class="row mt-2 mb-2">
        <div class="col-auto">
          <H4><div id="galleryNameField"></div></H4>
          <H1><div id="exhibitNameField"></div></H1>
        </div>
      </div>

      <nav>
        <div class="nav nav-tabs" id="nav-tab" role="tablist">
          <a class="nav-item nav-link active" id="nav-components-tab" data-toggle="tab" href="#nav-components" role="tab" aria-controls="nav-components" aria-selected="true">Components</a>
          <a class="nav-item nav-link" id="nav-schedule-tab" data-toggle="tab" href="#nav-schedule" role="tab" aria-controls="nav-schedule" aria-selected="false">Schedule</a>
          <a class="nav-item nav-link" id="nav-settings-tab" data-toggle="tab" href="#nav-settings" role="tab" aria-controls="nav-settings" aria-selected="false">Settings</a>
          <a class="nav-item nav-link" id="nav-help-tab" data-toggle="tab" href="#nav-help" role="tab" aria-controls="nav-help" aria-selected="false">Help</a>
        </div>
      </nav>

      <div class="tab-content" id="nav-tabContent">

        <div class="tab-pane fade show active" id="nav-components" role="tabpanel" aria-labelledby="nav-components-tab">

          <div class="modal" tabindex="-1" role="dialog" id="componentInfoModal">
            <div class="modal-dialog modal-dialog-centered" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h4 class="modal-title" id="componentInfoModalTitle"></h4>
                </div>
                <div class="modal-body">

                  <div class="row" id="componentInfoConnectingNotice">
                    <div class='col-8 offset-2'>
                      <center>
                        <H5 id="componentInfoConnectionStatusInPrograss">Connecting to component...</H5>
                        <H5 id="componentInfoConnectionStatusFailed">Unable to connect to component</H5>
                      </center>
                    </div>
                  </div>

                  <div class='row align-items-end' id="contentUploadSystemStatsView">

                    <div class='col-4'>
                      <strong id="contentUploadDiskSpaceFree"></strong>
                      <div class="progress" style="height: 30px;">
                        <div id="contentUploadDiskSpaceUsedBar" class="progress-bar bg-success" role="progressbar" style="width: 70%;" aria-valuenow="30" aria-valuemin="0" aria-valuemax="100"></div>
                        <div id="contentUploadDiskSpaceFreeBar" class="progress-bar bg-secondary" role="progressbar" style="width: 30%;" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                    </div>

                    <div class='col-4'>
                      <strong id="contentUploadCPUUsed"></strong>
                      <div class="progress" style="height: 30px;">
                        <div id="contentUploadCPUUsedBar" class="progress-bar bg-success" role="progressbar" style="width: 70%;" aria-valuenow="30" aria-valuemin="0" aria-valuemax="100"></div>
                        <div id="contentUploadCPUFreeBar"class="progress-bar bg-secondary" role="progressbar" style="width: 30%;" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                    </div>

                    <div class='col-4'>
                      <strong id="contentUploadRAMUsed"></strong>
                      <div class="progress" style="height: 30px;">
                        <div id="contentUploadRAMUsedBar" class="progress-bar bg-success" role="progressbar" style="width: 60%;" aria-valuenow="30" aria-valuemin="0" aria-valuemax="100"></div>
                        <div id="contentUploadRAMFreeBar" class="progress-bar bg-secondary" role="progressbar" style="width: 40%;" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                    </div>
                    <hr>
                  </div>

                  <div id="componentAvailableContentRow" class="row">
                    <H5 class="col-12 mt-3">Available content</H5>
                    <nav class="col-12">
                      <div class="nav nav-tabs" id="componentAvailableContentList-tabs" role="tablist">
                        <a class="nav-item nav-link active" id="componentAvailableContentList-thisExhibitTab" data-toggle="tab" href="#componentAvailableContentList-thisExhibit" role="tab" aria-controls="componentAvailableContentList-thisExhibit" aria-selected="true">This exhibit</a>
                        <a class="nav-item nav-link" id="componentAvailableContentList-allExhibitsTab" data-toggle="tab" href="#componentAvailableContentList-allExhibits" role="tab" aria-controls="componentAvailableContentList-allExhibits" aria-selected="false">All exhibits</a>
                      </div>
                    </nav>
                    <div class="tab-content col-12 mt-2" id="componentAvailableContentList">
                      <div class="tab-pane fade show active col-12" id="componentAvailableContentList-thisExhibit" role="tabpanel" aria-labelledby="componentAvailableContentList-thisExhibitTab">
                      </div>
                      <div class="tab-pane fade col-12" id="componentAvailableContentList-allExhibits" role="tabpanel" aria-labelledby="componentAvailableContentList-allExhibitsTab">
                      </div>
                    </div>
                  </div>

                  <div id="componentcontentUploadInterface" class="form-group mt-3">
                    <label for="componentContentUpload"><H5>Upload new content</H5></label>
                    <div class="row align-middle">
                      <div class="col-8">
                        <label class="btn btn-outline-secondary text-wrap">
                          <span id="componentContentUploadfilename">Choose file</span>
                          <input hidden type="file" class="form-control-file" id="componentContentUpload" onchange="onUploadContentChange()">
                        </label>
                      </div>
                      <div class="col-4">
                        <button id="contentUploadSubmitButton" class='btn btn-block btn-outline-primary' onclick="uploadComponentContentFile()">Upload</button>
                      </div>

                        <div class='col-12 mt-3' id='contentUploadProgressBarContainer'>
                          <div class="progress" style="height: 25px;">
                            <div id='contentUploadProgressBar' class="progress-bar" role="progressbar" style="width: 30%; font-size: large;" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100"></div>
                          </div>
                        </div>
                      <div class='col-12 text-danger mt-2' id='uploadOverwriteWarning'>Warning: this upload will overwrite a file of the same name.</div>
                      <div class='col-12 text-danger mt-2' id='contentUploadEqualSignWarning'>Filenames cannot contain the equal sign (=).</div>

                    </div>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-danger" onclick="submitComponentContentChange()" id="componentSaveConfirmationButton">Save changes</button>
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                </div>
              </div>
            </div>
          </div>

          <div class="modal" tabindex="-1" role="dialog" id="fileDeleteModal">
            <div class="modal-dialog modal-dialog-centered" role="document">
              <div class="modal-content" style="border:black 1px solid;">
                <div class="modal-header">
                  <h4 class="modal-title" id="fileDeleteModalTitle">Are you sure?</h4>
                </div>
                <div class="modal-body">
                  <div class="row">
                    <div class="col-auto" id="fileDeleteModalText"></div>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-danger" id="fileDeleteConfirmationButton">Delete File</button>
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                </div>
              </div>
            </div>
          </div>

          <div class="modal" tabindex="-1" role="dialog" id="projectorInfoModal">
            <div class="modal-dialog modal-dialog-centered" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h4 class="modal-title" id="projectorInfoModalTitle"></h4>
                </div>
                <div class="modal-body">
                  <table class="table table-striped">
                    <tbody>
                      <tr>
                        <th scope="row">Power state</th>
                        <td><div id="projectorInfoPowerState"></div></td>
                      </tr>
                      <tr>
                        <th scope="row">Lamp hours</th>
                        <td><div id="projectorInfoLampHours"></div></td>
                      </tr>
                      <tr>
                        <th scope="row">Lamp state</th>
                        <td><div id="projectorInfoLampState"></div></td>
                      </tr>
                      <tr>
                        <th scope="row">Fan state</th>
                        <td><div id="projectorInfoFanState"></div></td>
                      </tr>
                      <tr>
                        <th scope="row">Temperature state</th>
                        <td><div id="projectorInfoTempState"></div></td>
                      </tr>
                      <tr>
                        <th scope="row">Filter state</th>
                        <td><div id="projectorInfoFilterState"></div></td>
                      </tr>
                      <tr>
                        <th scope="row">Cover state</th>
                        <td><div id="projectorInfoCoverState"></div></td>
                      </tr>
                      <tr>
                        <th scope="row">Other</th>
                        <td><div id="projectorInfoOtherState"></div></td>
                      </tr>
                      <tr>
                        <th scope="row">Model</th>
                        <td><div id="projectorInfoModel"></div></td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          </div>

          <div class="row" id="componentGroupsRow">
          </div>
        </div>

        <div class="tab-pane fade" id="nav-schedule" role="tabpanel" aria-labelledby="nav-schedule-tab">

          <div class="modal" tabindex="-1" role="dialog" id="scheduleEditModal">
            <div class="modal-dialog modal-dialog-centered" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Edit schedule</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <form id="scheduleEditForm">
                    <div class="form-group">
                      <label for="daySelect">Select day(s)</label>
                      <select multiple class="form-control" id="daySelect">
                        <option>Monday</option>
                        <option>Tuesday</option>
                        <option>Wednesday</option>
                        <option>Thursday</option>
                        <option>Friday</option>
                        <option>Saturday</option>
                        <option>Sunday</option>
                      </select>

                    </div>
                    <div class="form-group">
                      <div class="row">
                        <div class="col-6">
                          <label for="onTimeEntry">Turn on time</label>
                          <input type="text" class="form-control" id="onTimeEntry" placeholder="e.g., 9:30 AM">
                        </div>
                        <div class="col-6">
                          <label for="offTimeEntry">Turn off time</label>
                          <input type="text" class="form-control" id="offTimeEntry" placeholder="e.g., 5:30 PM">
                        </div>
                        <div class='col mt-2'>
                          <p>To remove a scheduled action, leave the field blank.</p>
                        </div>
                      </div>
                    </div>
                  </form>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-primary" onclick="sendScheduleUpdate()" id="scheduleEditSubmitButton">Save changes</button>
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                </div>
              </div>
            </div>
          </div>

          <div class="row mt-4">
            <div class='col'>
              <h4><b>Next scheduled action: </b><span id="Schedule_next_event"></span></h4>
            </div>
          </div>
          <div class='row mt-2'>
            <div class="col-sm-10 col-md-7 col-lg-5 col-xl-5">
              <table class="table table-striped">
                <thead class="thead-dark">
                  <tr>
                    <th scope="col">Day</th>
                    <th scope="col">Turn on time</th>
                    <th scope="col">Turn off time</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <th scope="row">Monday</th>
                    <td><div id="Schedule_monday_on"></div></td>
                    <td><div id="Schedule_monday_off"></div></td>
                  </tr>
                  <tr>
                    <th scope="row">Tuesday</th>
                    <td><div id="Schedule_tuesday_on"></div></td>
                    <td><div id="Schedule_tuesday_off"></div></td>
                  </tr>
                  <tr>
                    <th scope="row">Wednesday</th>
                    <td><div id="Schedule_wednesday_on"></div></td>
                    <td><div id="Schedule_wednesday_off"></div></td>
                  </tr>
                  <tr>
                    <th scope="row">Thursday</th>
                    <td><div id="Schedule_thursday_on"></div></td>
                    <td><div id="Schedule_thursday_off"></div></td>
                  </tr>
                  <tr>
                    <th scope="row">Friday</th>
                    <td><div id="Schedule_friday_on"></div></td>
                    <td><div id="Schedule_friday_off"></div></td>
                  </tr>
                  <tr>
                    <th scope="row">Saturday</th>
                    <td><div id="Schedule_saturday_on"></div></td>
                    <td><div id="Schedule_saturday_off"></div></td>
                  </tr>
                  <tr>
                    <th scope="row">Sunday</th>
                    <td><div id="Schedule_sunday_on"></div></td>
                    <td><div id="Schedule_sunday_off"></div></td>
                  </tr>
                </tbody>
              </table>
              <button class='btn btn-info' data-toggle="modal" data-target="#scheduleEditModal">Edit schedule  </button>
            </div>
          </div>
        </div>

        <div class="tab-pane fade" id="nav-settings" role="tabpanel" aria-labelledby="nav-settings-tab">

          <div class="modal" tabindex="-1" role="dialog" id="changeExhibitModal">
            <div class="modal-dialog modal-dialog-centered" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Are you sure?</h5>
                </div>
                <div class="modal-body">
                  Changing the exhibit will be immediately visible to guests and the changing process may be unsightly for up to a minute.
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-danger" onclick="changeExhibit(true)" id="exhibitChangeConfirmationButton">Change exhibit</button>
                  <button type="button" class="btn btn-success" data-dismiss="modal">Cancel</button>
                </div>
              </div>
            </div>
          </div>

          <div class="row mt-4">
            <div class="col-6 col-md-3 col-lg-2">
              <button type="button" class="btn btn-primary" id="reloadConfigurationButton" onclick="reloadConfiguration()">Reload Config</button>
            </div>
            <div class="col-6 col-md-4 col-lg-3">
              <div class="form-group">
                <label for="exhibitSelect">Set current exhibit</label>
                <select class="form-control" id="exhibitSelect" onchange="changeExhibit(false)"></select>
              </div>
            </div>
          </div>
        </div>

        <div class="tab-pane fade" id="nav-help" role="tabpanel" aria-labelledby="nav-help-tab">
          <div class="row mt-4">
            <div id='helpTextDiv' class='col-auto'>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script type="text/javascript" src="js/jquery-3.5.1.slim.min.js"></script>
    <script type="text/javascript" src="js/popper.min.js"></script>
    <script type="text/javascript" src="js/bootstrap.min.js"></script>
    <script type="text/javascript" src="js/showdown.min.js"></script>
    <script>

      class ExhibitComponent {

        constructor(id, type) {
          this.id = id;
          this.type = type;
          this.content = null;
          this.ip = "localhost"; // Default; will be replaced when componet pings in
          this.helperPort = 8000; // Default; will be replaced when componet pings in
          this.state = {};
          this.status = "OFFLINE";
          this.buildHTML();

          if (this.type == "PROJECTOR") {
            this.checkProjector();
            var thisInstance = this;
            this.pollingFunction = setInterval(function() {thisInstance.checkProjector()}, 10000);
          }
        }

        remove() {

          // Remove the component from its ComponentGroup
          getExhibitComponentGroup(this.type).removeComponent(this.id);
          // Remove the component from the exhibitComponents list
          var thisInstance = this;
          exhibitComponents = $.grep(exhibitComponents, function(el, idx) {return el.id == thisInstance.id}, true);
          // Cancel the pollingFunction
          clearInterval(this.pollingFunction);
          // Rebuild the interface
          rebuildComponentInterface();
        }

        checkProjector() {

          // Function to ask the server to ping the projector
          var thisInstance = this;
          //requestString = `class=webpage&action=fetchProjectorUpdate&id=${this.id}`;
          var requestDict = {"class": "webpage",
                             "action": "fetchProjectorUpdate",
                             "id": this.id};

          var xhr = new XMLHttpRequest();
          xhr.timeout = 2000;
          xhr.open("POST", serverIP, true);
          xhr.setRequestHeader('Content-Type', 'application/json');
          xhr.onreadystatechange = function () {
            if (this.readyState != 4) return;

            if (this.status == 200) {
              var response = JSON.parse(this.responseText);
              if ("status" in response) {
                if (response["status"] != "DELETE") {
                    thisInstance.setStatus(response["status"]);
                } else {
                  thisInstance.remove();
                }
                if ("model" in response) {
                  thisInstance.state["model"] = response["model"];
                }
                if ("power_state" in response) {
                  thisInstance.state["power_state"] = response["power_state"];
                }
                if ("lamp_status" in response) {
                  thisInstance.state["lamp_status"] = response["lamp_status"];
                }
                if ("error_status" in response) {
                  thisInstance.state["error_status"] = response["error_status"];
                }
              }
            }
          };
          xhr.send(JSON.stringify(requestDict));
        }

        setStatus(status) {
          this.status = status;
          $("#" + this.id + "StatusField").html(status);

          var btnClass = this.getButtonColorClass();
          // Strip all existing classes
          $("#" + this.id + "MainButton").removeClass("btn-primary btn-warning btn-danger btn-success btn-info").addClass(btnClass);
          $("#" + this.id + "DropdownButton").removeClass("btn-primary btn-warning btn-danger btn-success btn-info").addClass(btnClass);
        }

        getButtonColorClass() {

          // Get the Bootstrap class based on the current status
          var btnClass = 'btn-danger';
          if (this.status == 'ACTIVE') {
            btnClass = 'btn-primary';
          } else if (this.status == "ONLINE") {
            btnClass = 'btn-success';
          } else if (this.status == "WAITING") {
            btnClass = 'btn-warning';
          } else if (this.status == "STANDBY") {
            btnClass = 'btn-info';
          }

          return btnClass;
        }

        buildHTML() {

          // Function to build the HTML representation of this component
          // and add it to the row of the parent group

          var onCmdName = "";
          var offCmdName = "";
          var displayName = this.id;
          if (this.type == "PROJECTOR") {
            onCmdName = "Wake projector";
            offCmdName = "Sleep projector";
            displayName = displayName.toUpperCase();
          } else {
            onCmdName = "Wake display";
            offCmdName = "Sleep display";
          }

          var html = `
            <div class='col-md-12 col-lg-6 mt-1'>
              <div class="btn-group btn-block">
                <button type="button" class="btn btn-danger btn-block" id="${this.id}MainButton" onclick="showExhibitComponentInfo('${this.id}')"><H5>${displayName}</H5><div id="${this.id}StatusField">OFFLINE</div></button>
                <button type="button" id="${this.id}DropdownButton" class="btn btn-danger dropdown-toggle dropdown-toggle-split"  data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <span class="sr-only">Toggle Dropdown</span>
                </button>
                <div class="dropdown-menu">
                  <a class="dropdown-item handCursor" onclick="queueCommand('${this.id}', 'wakeDisplay')">${onCmdName}</a>
                  <a class="dropdown-item handCursor" onclick="queueCommand('${this.id}', 'sleepDisplay')">${offCmdName}</a>
                </div>
              </div>
            </div>
          `;

          $('#'+this.type+'ComponentList').append(html);
        }
      }

      class ExhibitComponentGroup {

        constructor(type) {
          this.type = type;
          this.components = [];
          this.buildHTML();
        }

        addComponent(component) {
          this.components.push(component);
          this.sortComponentList();

        }

        sortComponentList() {

          // Sort the component list by ID and then rebuild the HTML
          // representation in order

          if (this.components.length > 1) {
            // This line does the sorting
            this.components.sort((a,b) => (a.id > b.id) ? 1 : ((b.id > a.id) ? -1 : 0))

            document.getElementById(this.type + "ComponentList").innerHTML = ""
            for (var i=0; i<this.components.length; i++) {
              this.components[i].buildHTML();
            }
          }
        }

        removeComponent(id) {
          // Remove a component based on its id

          this.components = $.grep(this.components, function(el, idx) {return el.id == id}, true);
        }

        buildHTML() {

          // Function to build the HTML representation of this group
          // and add it to the componentGroupsRow

          var onCmdName = "";
          var offCmdName = "";
          if (this.type == "PROJECTOR") {
            onCmdName = "Wake all projectors";
            offCmdName = "Sleep all projectors";
          } else {
            onCmdName = "Wake all displays";
            offCmdName = "Sleep all displays";
          }

          var html = `
            <div class='col-md-6 col-lg-5 col-xl-4 mt-4'>
              <div class="btn-group btn-block">
                <button type="button" class="btn btn-secondary btn-block btn-lg">${this.type}</button>
                <button type="button" class="btn btn-secondary dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <span class="sr-only">Toggle Dropdown</span>
                </button>
                <div class="dropdown-menu">
                  <a class="dropdown-item handCursor" onclick="sendGroupCommand('${this.type}', 'wakeDisplay')">${onCmdName}</a>
                  <a class="dropdown-item handCursor" onclick="sendGroupCommand('${this.type}', 'sleepDisplay')">${offCmdName}</a>
                </div>
              </div>
              <div class="row" id='${this.type}ComponentList'>
              </div>
            </div>
          `;

          $('#componentGroupsRow').append(html);
        }
      }

      function showExhibitComponentInfo(id) {

        // This sets up the componentInfoModal with the info from the selected
        // component and shows it on the screen.

        if (id == "") {
          id = $("#componentInfoModalTitle").html();
        }

        var obj = getExhibitComponent(id);

        if (obj.type == "PROJECTOR") {
          $("#projectorInfoModalTitle").html(id.toUpperCase());
          $("#projectorInfoPowerState").html(obj.state["power_state"]);
          $("#projectorInfoLampState").html((obj.state["error_status"])["lamp"]);
          $("#projectorInfoFanState").html((obj.state["error_status"])["fan"]);
          $("#projectorInfoFilterState").html((obj.state["error_status"])["filter"]);
          $("#projectorInfoCoverState").html((obj.state["error_status"])["cover"]);
          $("#projectorInfoOtherState").html((obj.state["error_status"])["other"]);
          $("#projectorInfoTempState").html((obj.state["error_status"])["temperature"]);
          $("#projectorInfoModel").html(obj.state["model"]);

          var lampList = obj.state["lamp_status"];
          var lamp_html = ""
          for (var i=0; i<lampList.length; i++) {
            lamp = lampList[i]
            var statusStr = ""
            if (lamp[1] == false) {
              statusStr = "(off)"
            } else {
              statusStr = "(on)"
            }
            lamp_html += `Lamp ${i+1} ${statusStr}: ${lamp[0]} hours<br>`;
          }
          $("#projectorInfoLampHours").html(lamp_html);

          // Make the modal visible
          $("#projectorInfoModal").modal("show");

        } else { // This is a normal ExhibitComponent

          $("#componentInfoModalTitle").html(id);
          $("#componentAvailableContentList-thisExhibit").empty();
          $("#componentAvailableContentList-allExhibits").empty();
          $("#contentUploadSubmitButton").prop("disabled", false);
          $("#contentUploadSubmitButton").html("Upload");
          $("#componentContentUploadfilename").html("Choose file")
          $("#componentContentUpload").val(null);
          $("#contentUploadSubmitButton").hide()
          $("#contentUploadEqualSignWarning").hide();
          $("#uploadOverwriteWarning").hide();
          $("#contentUploadProgressBarContainer").hide();
          $("#contentUploadSystemStatsView").hide();
          $("#componentInfoConnectingNotice").show();
          $("#componentInfoConnectionStatusFailed").hide();
          $("#componentInfoConnectionStatusInPrograss").show();
          $("#componentSaveConfirmationButton").hide();
          $("#componentAvailableContentRow").hide();
          $("#componentcontentUploadInterface").hide();

          var showFailureMessage = function() {
            $("#componentInfoConnectionStatusFailed").show();
            $("#componentInfoConnectionStatusInPrograss").hide();
          }

          var requestString = JSON.stringify({"action": "getAvailableContent"});

          var xhr = new XMLHttpRequest();
          xhr.open("POST", `http://${obj.ip}:${obj.helperPort}`, true);
          xhr.timeout = 10000 // 10 seconds
          xhr.ontimeout = showFailureMessage;
          xhr.onerror = showFailureMessage;
          xhr.setRequestHeader('Content-Type', 'application/json');
          xhr.onreadystatechange = function () {
            if (this.readyState != 4) return;

            if (this.status == 200) {

              // Good connection, so show the interface elements
              $("#componentAvailableContentRow").show();
              $("#componentcontentUploadInterface").show();
              $("#componentInfoConnectingNotice").hide();

              var availableContent = JSON.parse(this.response);

              // If it is provided, show the system stats
              if ("system_stats" in availableContent) {
                var stats = availableContent["system_stats"];

                // Disk
                $("#contentUploadDiskSpaceUsedBar").attr("ariaValueNow", 100 - stats["disk_pct_free"]);
                $("#contentUploadDiskSpaceUsedBar").width(String(100 - stats["disk_pct_free"])+"%");
                $("#contentUploadDiskSpaceFreeBar").attr("ariaValueNow", stats["disk_pct_free"]);
                $("#contentUploadDiskSpaceFreeBar").width(String(stats["disk_pct_free"])+"%");
                $("#contentUploadDiskSpaceFree").html(`Disk: ${String(Math.round(stats["disK_free_GB"]))} GB`);
                if (stats["disk_pct_free"] > 20) {
                  $("#contentUploadDiskSpaceUsedBar").removeClass("bg-warning bg-danger").addClass("bg-success")
                } else if (stats["disk_pct_free"] > 10) {
                  $("#contentUploadDiskSpaceUsedBar").removeClass("bg-success bg-danger").addClass("bg-warning")
                } else {
                  $("#contentUploadDiskSpaceUsedBar").removeClass("bg-success bg-warning").addClass("bg-danger")
                }

                // CPU
                $("#contentUploadCPUUsedBar").attr("ariaValueNow", stats["cpu_load_pct"]);
                $("#contentUploadCPUUsedBar").width(String(stats["cpu_load_pct"])+"%");
                $("#contentUploadCPUFreeBar").attr("ariaValueNow", 100 - stats["cpu_load_pct"]);
                $("#contentUploadCPUFreeBar").width(String(100 - stats["cpu_load_pct"])+"%");
                $("#contentUploadCPUUsed").html(`CPU: ${String(Math.round(stats["cpu_load_pct"]))}%`);
                if (stats["cpu_load_pct"] < 80) {
                  $("#contentUploadCPUUsedBar").removeClass("bg-warning bg-danger").addClass("bg-success")
                } else if (stats["cpu_load_pct"] < 90) {
                  $("#contentUploadCPUUsedBar").removeClass("bg-success bg-danger").addClass("bg-warning")
                } else {
                  $("#contentUploadCPUUsedBar").removeClass("bg-success bg-warning").addClass("bg-danger")
                }

                // RAM
                $("#contentUploadRAMUsedBar").attr("ariaValueNow", stats["ram_used_pct"]);
                $("#contentUploadRAMUsedBar").width(String(stats["ram_used_pct"])+"%");
                $("#contentUploadRAMFreeBar").attr("ariaValueNow", 100 - stats["ram_used_pct"]);
                $("#contentUploadRAMFreeBar").width(String(100 - stats["ram_used_pct"])+"%");
                $("#contentUploadRAMUsed").html(`RAM: ${String(Math.round(stats["ram_used_pct"]))}%`);
                if (stats["ram_used_pct"] < 80) {
                  $("#contentUploadRAMUsedBar").removeClass("bg-warning bg-danger").addClass("bg-success")
                } else if (stats["ram_used_pct"] < 90) {
                  $("#contentUploadRAMUsedBar").removeClass("bg-success bg-danger").addClass("bg-warning")
                } else {
                  $("#contentUploadCPUUsedBar").removeClass("bg-success bg-warning").addClass("bg-danger")
                }

                $("#contentUploadSystemStatsView").show();
              } else {
                $("#contentUploadSystemStatsView").hide();
              }

              var populateContent = function(key, id, div) {

                // Get filenames listed under key in availableContent and add
                // the resulting buttons to the div given by div

                for (var i=0; i<availableContent[key].length; i++) {
                  var content = (availableContent[key])[i];
                  var activeContent = availableContent["active_content"];
                  if (activeContent.includes(content)) {
                    var active = "btn-primary";
                  } else {
                    var active = "btn-secondary";
                  }
                  var html = `
                  <div class="col-auto mt-1">
                    <div class="btn-group">
                      <button type="button" id="${content.split('.').join("").split(/[\\\/]/).join("")}Button" class="btn componentContentButton ${active}">${content}</button>
                      <button type="button" id="${content.split('.').join("").split(/[\\\/]/).join("")}ButtonDropdown" class="btn dropdown-toggle dropdown-toggle-split componentContentDropdownButton ${active}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <span class="sr-only">Toggle Dropdown</span>
                      </button>
                      <div class="dropdown-menu">
                        <a class="dropdown-item disabled text-secondary">Rename</a>
                        <a class="dropdown-item disabled"></a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item text-danger" onclick="deleteRemoteFile('${id}', '${content}')">Delete</a>
                      </div>
                    </div>
                  </div>
                  `;
                  $("#"+div).append(html);
                }
              }

              // Build buttons for each file in the current exhibit
              populateContent('current_exhibit', id, "componentAvailableContentList-thisExhibit")

              // Build buttons for each file in all exhibits
              populateContent('all_exhibits', id, "componentAvailableContentList-allExhibits")

              // Attach an event handler to change the button's color when clicked
              $(".componentContentButton").on("click", function(e){
                var id = $(this).attr("id");
                // $('.componentContentButton').not($(this)).removeClass("btn-primary").addClass("btn-secondary");
                $(this).toggleClass("btn-primary").toggleClass("btn-secondary");

                // $('.componentContentDropdownButton').not($("#"+id+"Dropdown")).removeClass("btn-primary").addClass("btn-secondary");
                $("#"+id+"Dropdown").toggleClass("btn-secondary").toggleClass("btn-primary");

                if ($(".componentContentButton.btn-primary").length == 0) {
                  $("#componentSaveConfirmationButton").hide(); // Can't save a state with no selected content.
                } else {
                  $("#componentSaveConfirmationButton").show();
                }
              });
            }
          };
          xhr.send(requestString);

          // Make the modal visible
          $("#componentInfoModal").modal("show");
        }

      }

      function deleteRemoteFile(id, file, warn=true) {

        // If called with warn=True, show a modal asking to delete the file.
        // Otherwise, send the command to delete.

        var model = $("#fileDeleteModal");

        if (warn == true) {
          $("#fileDeleteModalText").html(`Delete ${file} from ${id}?`);
          // Remove any previous event handler and then add one to actually do the deletion.
          $("#fileDeleteConfirmationButton").off();
          $("#fileDeleteConfirmationButton").on("click", function(){
            deleteRemoteFile(id, file, warn=false);
          });
          model.modal("show");
        } else {
          var file_split = file.split(/[\\\/]/); // regex to split on forward and back slashes
          var exhibit;
          var file_to_delete;
          if (file_split.length > 1) {
            // our file is of form "exhibit/file"
            exhibit = file_split[0];
            file_to_delete = file_split[1]
          } else {
            exhibit = currentExhibit.split(".")[0];
            file_to_delete = file;
          }
          var obj = getExhibitComponent(id);
          var requestString = JSON.stringify({"action": "deleteFile",
                                              "file": file_to_delete,
                                              "fromExhibit": exhibit});

          var xhr = new XMLHttpRequest();
          xhr.timeout = 2000;
          xhr.open("POST", `http://${obj.ip}:${obj.helperPort}`, true);
          xhr.setRequestHeader('Content-Type', 'application/json');
          xhr.send(requestString);

          model.modal("hide");
          showExhibitComponentInfo(id);
        }

      }

      function onUploadContentChange() {

        // When we select a file for uploading, check against the existing files
        // (as defined by their buttons) and warn if we will overwrite. Also
        // check if the filename contains an =, which is not allowed

        $("#contentUploadSubmitButton").show();
        // Show the upload button (we may hide it later)
        var fileInput = $("#componentContentUpload")[0];
        // Check for filename collision
        var currentFiles = $(".componentContentButton").map(function(){return $(this).html()}).toArray();
        $("#componentContentUploadfilename").html("File: " + fileInput.files[0].name);
        if(currentFiles.includes(fileInput.files[0].name)) {
          $("#uploadOverwriteWarning").show();
        } else {
          $("#uploadOverwriteWarning").hide();
        }
        // Check for = in filename
        if (fileInput.files[0].name.includes("=")) {
          $("#contentUploadEqualSignWarning").show();
          $("#contentUploadSubmitButton").hide();
        } else {
          $("#contentUploadEqualSignWarning").hide();
        }
      }

      function uploadComponentContentFile() {

        var fileInput = $("#componentContentUpload")[0];
        if (fileInput.files[0] != null){
          var id = $("#componentInfoModalTitle").html().trim();

          var component = getExhibitComponent(id);

          $("#contentUploadSubmitButton").prop("disabled", true);
          $("#contentUploadSubmitButton").html("Working...");

          var file = fileInput.files[0]
          var formData = new FormData();
          formData.append("exhibit", getCurrentExhibitName())
          formData.append("filename", file["name"])
          formData.append("mimetype", file["type"])
          formData.append("file", file);

          var xhr = new XMLHttpRequest();
          xhr.open("POST", `http://${component.ip}:${component.helperPort}`, true);
          xhr.onreadystatechange = function () {
            if (this.readyState != 4) return;
            if (this.status == 200) {
              var response = JSON.parse(this.responseText);

              if ("success" in response) {
                queueCommand(id, 'reloadDefaults')
                showExhibitComponentInfo("");
              }
            }
          };

          xhr.upload.addEventListener("progress", function(evt) {
            if (evt.lengthComputable) {
              var percentComplete = evt.loaded / evt.total;
              percentComplete = parseInt(percentComplete * 100);
              $("#contentUploadProgressBar").width(String(percentComplete) + "%");
              if (percentComplete > 0) {
                $("#contentUploadProgressBarContainer").show();
              }
              else if (percentComplete == 100) {
                $("#contentUploadProgressBarContainer").hide();
              }
            }
          }, false);

          xhr.send(formData);
        }

      }

      function submitComponentContentChange() {

        // Collect the new information from the componentInfoModal and pass it
        // back to the server to be changed.

        var id = $("#componentInfoModalTitle").html().trim();
        var selectedButtons = $('.componentContentButton.btn-primary');
        var component = getExhibitComponent(id);
        var contentList = [];
        for (var i=0; i<selectedButtons.length; i++) {
          content = selectedButtons[i].innerHTML.trim();
          content_split = content.split(/[\\\/]/); // regex to split on forward and back slash

          // If the split > 1, we have a path, indicating we are selected content
          // from another exhibit and need to copy it over first.
          if (content_split.length > 1) {
            var currentExhibitName = currentExhibit.split('.')[0];
            if (currentExhibitName == content_split[0]) {
              // This file is already part of the exhibit and just needs to be selected
              content = content_split[1];
            } else {
              // This file is loaded only for another exhibit. First we need to
              // ask the remote helper to copy the file to the directory for this
              // exhibit.
              content = content_split[1];

              requestString = JSON.stringify({
                "action": "copyFile",
                "file": content,
                "fromExhibit": content_split[0],
                "toExhibit": currentExhibitName
              })
              var xhr = new XMLHttpRequest();
              xhr.open("POST", `http://${component.ip}:${component.helperPort}`, true);
              xhr.setRequestHeader('Content-Type', 'application/json');
              // xhr.onreadystatechange = function () {
              //   if (this.readyState != 4) return;
              //
              //   if (this.status == 200) {
              //     sendComponentContentChangeRequest(id, content)
              //   }
              // };
              xhr.send(requestString);
            }
          }
          contentList.push(content);
          sendComponentContentChangeRequest(id, contentList);
        }

        askForUpdate();

        // Hide the modal
        $("#componentInfoModal").modal("hide");
      }

      function sendComponentContentChangeRequest(id, content) {

        // Send a request to the server to initiate a content change

        requestString = JSON.stringify({
          "class": "webpage",
          "action": "setComponentContent",
          "id": id,
          "content": content
        })
        var xhr = new XMLHttpRequest();
        xhr.timeout = 2000;
        xhr.open("POST", serverIP, true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.send(requestString);
      }

      function getExhibitComponent(id) {

        // Function to search the exhibitComponents list for a given id

        var result = exhibitComponents.find(obj => {
          return obj.id === id
        });

        return result;
      }

      function getExhibitComponentGroup(type) {

        // Function to search the exhibitComponents list for a given id

        var result = componentGroups.find(obj => {
          return obj.type === type
        });

        return result;
      }

      function updateComponentFromServer(component) {

        obj = getExhibitComponent(component["id"])
        if (obj != null) {
          // Update the object with the latest info from the server
          obj.setStatus(component["status"]);
          if ("content" in component) {
            obj.content = component["content"];
          }
          if ("ip_address" in component) {
            obj.ip = component["ip_address"];
          }
          if ("helperPort" in component) {
            obj.helperPort = component["helperPort"];
          }
        } else {

          // First, make sure the group matching this type exists
          var group = getExhibitComponentGroup(component["type"]);
          if (group == null) {
            var group = new ExhibitComponentGroup(component["type"]);
            componentGroups.push(group);
          }

          // Then create a new component
          var newComponent = new ExhibitComponent(component["id"], component["type"]);
          newComponent.setStatus(component["status"]);
          exhibitComponents.push(newComponent);

          // Add the component to the right group
          group.addComponent(newComponent);

          newComponent.setStatus(component["status"]);
        }
      }

      function setCurrentExhibitName(name) {
        currentExhibit = name;
        document.getElementById("exhibitNameField").innerHTML = name;
        updateAvailableExhibits([name]);
      }

      function getCurrentExhibitName() {
        return(document.getElementById("exhibitNameField").innerHTML)
      }

      function updateAvailableExhibits(exhibitList) {

        for (var i=0; i<exhibitList.length; i++) {
          // Check if exhibit already exists as an option. If not, add it
          if ($(`#exhibitSelect option[value='${exhibitList[i]}']`).length == 0) {
            $("#exhibitSelect").append(new Option(exhibitList[i], exhibitList[i]));
          }
        }

      }

      function changeExhibit(warningShown) {

        // Send a command to the control server to change the current exhibit

        if (warningShown == false) {
          $("#changeExhibitModal").modal("show");
        }
        else {
          $("#changeExhibitModal").modal("hide");

          var requestDict = {"class": "webpage",
                             "action": "setExhibit",
                             "name": $("#exhibitSelect").val()};
          var xhr = new XMLHttpRequest();
          xhr.timeout = 2000;
          xhr.open("POST", serverIP, true);
          xhr.setRequestHeader('Content-Type', 'application/json');
          xhr.send(JSON.stringify(requestDict));

          askForUpdate();
        }

      }

      function reloadConfiguration() {

        // This function will send a message to the server asking it to reload
        // the current exhibit configuration file and update all the components

        //requestString = "class=webpage&action=reloadConfiguration";
        var requestDict = {"class": "webpage",
                           "action": "reloadConfiguration"};

        var xhr = new XMLHttpRequest();
        xhr.timeout = 2000;
        xhr.open("POST", serverIP, true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onreadystatechange = function () {
          if (this.readyState != 4) return;

          if (this.status == 200) {
            var response = JSON.parse(this.responseText);

            if ("result" in response) {
              if (response["result"] == "success") {
                $("#reloadConfigurationButton").html("Success!");
                setTimeout(function() { $("#reloadConfigurationButton").html("Reload Config"); }, 2000);
              }
            }
          }
        };
        xhr.send(JSON.stringify(requestDict));
      }

      function queueCommand(id, cmd) {

        // Function to send a command to the control server that will then
        // be sent to the component the next time it pings the server

        var obj = getExhibitComponent(id);
        var cmdType = ""
        if (obj.type == "PROJECTOR") {
          cmdType = "queueProjectorCommand";
        } else {
          cmdType = "queueCommand"
        }

        //var requestString = `class=webpage&action=${cmdType}&id=${id}&command=${cmd}`;
        var requestDict = {"class": "webpage",
                           "id": id,
                           "command": cmd,
                           "action": cmdType};

        var xhr = new XMLHttpRequest();
        xhr.timeout = 2000;
        xhr.open("POST", serverIP, true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.send(JSON.stringify(requestDict));
      }

      function sendGroupCommand(group, cmd) {

        // Iterate through the components in the given group and queue the command
        // for each

        var group = getExhibitComponentGroup(group);

        for (var i=0; i<group.components.length; i++) {
          queueCommand(group.components[i].id, cmd);
        }
      }

      function populateSchedule(schedule) {

        var keys = ['monday_on', 'monday_off', 'tuesday_on', 'tuesday_off', 'wednesday_on', 'wednesday_off', 'thursday_on', 'thursday_off', 'friday_on', 'friday_off', 'saturday_on', 'saturday_off', 'sunday_on', 'sunday_off', ];
        for (var i=0; i<keys.length; i++) {
          var key = keys[i];
          var item;
          if (key in schedule) {
            item = schedule[key];
          } else item = ""
          document.getElementById("Schedule_"+key).innerHTML = item;
        }

          var action = "";
          if (schedule["Next action"] == "sleepDisplay") {
            action = "Turn exhibit off";
          } else if (schedule["Next action"] == "wakeDisplay") {
            action = "Turn exhibit on";
          }
          var value = ""
          if (schedule["Next time"] != "None") {
            value = `${action}${schedule["Next time"]}`;
          } else {
            value = `No actions scheduled`;
          }

          document.getElementById("Schedule_next_event").innerHTML = value;
      }

      function sendScheduleUpdate() {
        var days = $('#daySelect').val();
        var onTime = $('#onTimeEntry').val();
        var offTime = $('#offTimeEntry').val();

        if (days.length > 0) {

          var requestDict;
          for (var i=0; i<days.length; i++) {
              day = days[i];
              //requestString = `class=webpage&action=updateSchedule&day=${day}&onTime=${onTime}&offTime=${offTime}`;
              requestDict = {"class": "webpage",
                             "action": "updateSchedule",
                             "day": day,
                             "onTime": onTime,
                             "offTime": offTime};

              var xhr = new XMLHttpRequest();
              xhr.timeout = 2000;
              xhr.open("POST", serverIP, true);
              xhr.setRequestHeader('Content-Type', 'application/json');
              xhr.send(JSON.stringify(requestDict));
          }
          document.getElementById("scheduleEditForm").reset();
          $('#scheduleEditModal').modal('hide')
          askForUpdate();
        } else {
          // We are missing the day field, so pop up a warning to help
          $("#scheduleEditSubmitButton").popover({
                placement: 'right',
                trigger: 'focus',
                content: "You must select at least one day to modify!"
                });
          $("#scheduleEditSubmitButton").popover('show');
        }
      }

      function askForUpdate() {

        requestDict = {"class": "webpage",
                       "action": "fetchUpdate"};

        var xhr = new XMLHttpRequest();
        xhr.timeout = 2000;
        xhr.open("POST", serverIP, true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onreadystatechange = function () {
          if (this.readyState != 4) return;

          if (this.status == 200) {
              var update = JSON.parse(this.responseText);

              var n_comps = 0;
              var n_online = 0;
              for (var i=0; i<update["length"]; i++) {
                var component = update[String(i)];
                if ("class" in component) {
                  if (component["class"] == "exhibitComponent") {
                    n_comps += 1;
                    if ((component["status"] == "ONLINE") || (component["status"] == "STANDBY")) {
                      n_online += 1;
                    }
                    updateComponentFromServer(component);
                  } else if (component["class"] == "gallery") {
                    setCurrentExhibitName(component["currentExhibit"]);
                    updateAvailableExhibits(component["availableExhibits"]);
                    if ("galleryName" in component) {
                      $("#galleryNameField").html(component["galleryName"]);
                      document.title = component["galleryName"];
                    }
                  } else if (component["class"] == "schedule") {
                    populateSchedule(component);
                  }
                }
              }
              // Set the favicon to reflect the aggregate status
              if (n_online == n_comps) {
                $("link[rel='icon']").attr("href", "icon/green.ico");
              } else if (n_online == 0) {
                $("link[rel='icon']").attr("href", "icon/red.ico");
              } else {
                $("link[rel='icon']").attr("href", "icon/yellow.ico");
              }
          }
        };
        xhr.send(JSON.stringify(requestDict));
      }

      function rebuildComponentInterface() {

        // Clear the componentGroupsRow and rebuild it

        document.getElementById('componentGroupsRow').innerHTML = ""
        for (var i=0; i<componentGroups.length; i++) {
          componentGroups[i].buildHTML();
        }
        for (var i=0; i<exhibitComponents.length; i++) {
          exhibitComponents[i].buildHTML();
        }
      }

      function populateHelpTab() {

        // Ask the server to send the latest README, convert the Markdown to
        // HTML, and add it to the Help tab.

        var requestDict = {"class": "webpage",
                           "action": "getHelpText"}

        requestString = JSON.stringify(requestDict);

        var xhr = new XMLHttpRequest();
        xhr.timeout = 2000;
        xhr.open("POST", serverIP, true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onreadystatechange = function () {

          if (this.readyState != 4) return;

          if (this.status == 200) {
            if (this.responseText != "") {
              var formatted_text = markdownConverter.makeHtml(this.responseText);
              $("#helpTextDiv").html(formatted_text);
            } else {
              $("#helpTextDiv").html("Help text not available.");
            }
          }
        };
        xhr.send(requestString);
      }

      var serverIP = INSERT_SERVERIP_HERE // This will be automatically inserted by the server before being sent to the client
      var currentExhibit = "";
      var exhibitComponents = [];
      var componentGroups = [];
      var markdownConverter = new showdown.Converter();
      markdownConverter.setFlavor('github');

      askForUpdate();
      setInterval(askForUpdate, 5000);
      populateHelpTab();

    </script>

  </body>
</html>
