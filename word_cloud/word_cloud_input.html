<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />

    <meta name="description" content="">
    <meta name="author" content="Morgan Rehnberg">

    <style>

      html {
        touch-action: manipulation;
        word-wrap: break-word;
        overflow-y: hidden;
        height: 100%;
        position: relative;

        /* Disable text selection */
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }
      body {
        overflow-x: hidden;
        height: 100%;
        position: relative;
        background-color: #002f65;
      }
      #clearButton {
        font-size: 3vw;
        width: 15vw;
        font-family: sans-serif;
      }
      #inputField {
        display: block;
        width: 45vw;
        font-size: 3vw;

      }
      #inputContainer {
        width: 100vw;
        margin-top: 15vh;
        display: flex;
        justify-content: center;
      }
      #promptContainer {
        width: 100vw;
        margin-top: 15vh;
        display: flex;
        justify-content: center;
      }
      #promptText {
        font-size: 5vw;
        width: 80vw;
        text-align: center;
        color: white;
        font-family: sans-serif;
        font-weight: bold;
      }
      #submitButton {
        font-size: 3vw;
        width: 15vw;
        font-family: sans-serif;
      }
    </style>

    <title>Word Cloud Input</title>

  </head>

  <body>
    <div id="profanityCheckingDiv" style="display:none;"></div>
    <div id="promptContainer">
      <div id="promptText">
        What is your favorite thing to do on vacation?
      </div>
    </div>
    <div id="inputContainer">
      <button id="clearButton" onclick='$("#inputField").val("")'>Clear</button>
      <input id="inputField" class="js-virtual-keyboard" data-kioskboard-type="keyboard" data-kioskboard-specialcharacters="false" placeholder="Your response" />
      <button id="submitButton" onclick="sendTexttoServer()">Submit</button>
    </div>

  <!-- Load js file with helperAddress -->
  <script src="inputConfig.js"></script>
  <script src="js/jquery-3.5.1.slim.min.js"></script>
  <script src="js/jquery.profanityfilter.min.js"></script>
  <script src="js/swearWords.js"></script>
  <script src="js/kioskboard-aio-1.4.0.min.js"></script>
  <script>

    function arraysEqual(arr1, arr2) {

      // Function to check if two arrays have the same elements in the same order

      if (arr1.length != arr2.length) {
        return false;
      } else {
        for (var i=0; i<arr1.length; i++) {
          if (arr1[i] != arr2[i]) {
            return false;
          }
        }
        return true;
      }
    }

    function askForDefaults() {

      // Send a message to the local helper and ask for the latest configuration
      // defaults, then use them.

      var requestString = `action=getDefaults`;

      var xhr = new XMLHttpRequest();
      xhr.open("POST", helperAddress, true);
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.onreadystatechange = function () {

        if (this.readyState != 4) return;

        if (this.status == 200) {
          current_config = JSON.parse(this.responseText);
          readUpdate(this.responseText);
        }
      };
      xhr.send(requestString);
    }

    function getCleanText() {

      // Run the profanity checker on the input field

      $("#profanityCheckingDiv").html($("#inputField").val()).profanityFilter({customSwears: swearList, replaceWith: "#"});
      $("#profanityCheckingDiv").html($("#profanityCheckingDiv").html().replace(/#/g, ""));
      return($("#profanityCheckingDiv").html().trim())
    }

    function getCurrentExhibit() {

      // Ask the helper to send the current exhibit name and update as necessary

      var requestDict = {"action": "getCurrentExhibit"};
      var requestString = JSON.stringify(requestDict);

      var xhr = new XMLHttpRequest();
      xhr.open("POST", helperAddress, true);
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.onreadystatechange = function () {

        if (this.readyState != 4) return;

        if (this.status == 200) {
          if (this.responseText != "") {
            current_config["current_exhibit"] = this.responseText
          }
        }
      };
      xhr.send(requestString);
    }

    function readUpdate(responseText) {

      // Function to read a message from the server and take action based
      // on the contents

      var update = JSON.parse(responseText);

      //current_config = update;
      if ("id" in update) {
        id = update["id"];
      }
      if ("type" in update) {
        type = update["type"]
      }
      if (("server_ip_address" in update) && ("server_port" in update)) {
        serverAddress = "http://" + update["server_ip_address"] + ":" + update["server_port"];
      }
      if ("dictionary" in update) {
        dictionary = update["dictionary"];
      }
      if ('commands' in update) {
        for (var i=0; i<update["commands"].length; i++) {
          var cmd = (update["commands"])[i];

          if (cmd == "refresh_page") {
              location.reload();
          }
        }
      }
    }

    function sendAnalytics(data) {

      // Take the provided dicitonary of data and send it to the control server

      // Append the date and time of this recording
      var tzoffset = (new Date()).getTimezoneOffset() * 60000; // Time zone offset in milliseconds
      var date_str = (new Date(Date.now() - tzoffset)).toISOString().slice(0, -1);
      data["datetime"] = date_str;

      // Append the current exhibit
      data["exhibit"] = current_config["current_exhibit"]

      var requestDict = {"class": "tracker",
                         "action": "submitAnalytics",
                         "data": data,
                         "name": id};

      var requestString = JSON.stringify(requestDict);

      var xhr = new XMLHttpRequest();
      xhr.open("POST", serverAddress, true);
      xhr.timeout = 5000;
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.overrideMimeType( "text/plain; charset=x-user-defined" );
      xhr.onreadystatechange = function () {
        if (this.readyState != 4) return;
        if (this.status == 200) {
        }
      };
      xhr.send(requestString);
    }

    function sendPing() {

      // Contact the control server and ask for any updates

      if (serverAddress != "") {

        var allowedActionsDict = {"refresh": "true"}

        var requestDict = {"class": "exhibitComponent",
                           "id": id,
                           "type": type,
                           "allowed_actions": allowedActionsDict};

        var requestString = JSON.stringify(requestDict);

        var xhr = new XMLHttpRequest();
        xhr.timeout = 1000;
        xhr.open("POST", serverAddress, true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onerror = function() {
        }
        xhr.onreadystatechange = function () {

          if (this.readyState != 4) return;

          if (this.status == 200) {
            if (this.responseText != "") {
              readUpdate(this.responseText);
            }
          }
      };
        xhr.send(requestString);
      }
    }

    function sendTexttoServer() {

      // Send the server the text that the user has inputted
      var text = getCleanText()
      if (serverAddress != "" && text != "") {

        var requestDict = {"class": "tracker",
                           "name": `${current_config["viewer_id"]}-${current_config['current_exhibit']}`,
                           "action": "submitRawText",
                           "text": text};

        var requestString = JSON.stringify(requestDict);

        var xhr = new XMLHttpRequest();
        xhr.timeout = 1000;
        xhr.open("POST", serverAddress, true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onerror = function() {
        }
        xhr.onreadystatechange = function () {

          if (this.readyState != 4) return;

          if (this.status == 200) {
            if (this.responseText != "") {
              var result = JSON.parse(this.responseText);
              if ("success" in result && result["success"] == true) {
                $("#inputField").val("");
              }
            }
          }
      };
        xhr.send(requestString);
      }
    }

    // These will be replaced by the values specified in defaults.ini
    var id = 'UNKNWON';
    var type = 'WORDCLOUD_INPUT';
    var serverAddress = ""; // The address of the main control server
    var dictionary = null;
    var current_config = {}; // Will hold the defaults sent from the helper


    askForDefaults();

    setInterval(sendPing, 5000);

    KioskBoard.Init({

      keysArrayOfObjects: [{"0":"Q","1":"W","2":"E", "3": "R", "4": "T", "5": "Y", "6": "U", "7": "I", "8": "O", "9": "P"},
                           {"0":"A","1":"S","2":"D", "3": "F", "4": "G", "5": "H", "6": "J", "7": "K", "8": "L"},
                           {"0":"Z","1":"X","2":"C", "3": "V", "4": "B", "5": "N", "6": "M"}],

      // Language Code (ISO 639-1) for custom keys (for language support) => e.g. "de" || "en" || "fr" || "hu" || "tr" etc...
      language: 'en',
      // The theme of keyboard => "light" || "dark" || "flat" || "material" || "oldschool"
      theme: 'light',
      capsLockActive: true,
      allowRealKeyboard: true,
      allowMobileKeyboard: true,
      cssAnimations: true,
      cssAnimationsDuration: 360,
      cssAnimationsStyle: 'slide',
      keysAllowSpacebar: true,
      keysSpacebarText: 'Space',
      keysFontFamily: 'sans-serif',
      keysFontSize: '22px',
      keysFontWeight: 'normal',
      keysIconSize: '25px',
      autoScroll: true,
    });
    KioskBoard.Run('.js-virtual-keyboard');
  </script>
  </body>
</html>
